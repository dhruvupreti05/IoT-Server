#! /usr/bin/python

from influxdb import InfluxDBClient
from dotenv import load_dotenv
import requests
import dropbox
import io
import csv
import os

load_dotenv()

INFLUX_PORT = 8086

# Fetch Dropbox access token
access_token = requests.post(
    "https://api.dropbox.com/oauth2/token",
    data={
        "grant_type": "refresh_token",
        "refresh_token": os.getenv("REFRESH_TOKEN"),
        "client_id": os.getenv("APP_KEY"),
        "client_secret": os.getenv("APP_SECRET"),
    }
).json()["access_token"]

dbx = dropbox.Dropbox(access_token)
client = InfluxDBClient(host=os.getenv("INFLUX_HOST"), port=INFLUX_PORT, 
                        username=os.getenv("INFLUX_USER"), password=os.getenv("INFLUX_PASSWORD"))

def query_data(database, measurement):
    client.switch_database(database)
    query = f'SELECT * FROM "{measurement}"'
    return client.query(query)

def upload_to_dropbox(csv_content, measurement):
    # Upload CSV data directly from in-memory buffer
    dbx.files_upload(csv_content.encode(), f"/ServerData/{measurement}.csv")

if __name__ == "__main__":
    databases = [db["name"] for db in client.get_list_database()]
    
    for database in databases:
        client.switch_database(database)
        measurements = [m["name"] for m in client.get_list_measurements()]

        for measurement in measurements:
            result = query_data(database, measurement)
            
            # Create CSV data in memory
            csv_buffer = io.StringIO()
            csv_writer = csv.writer(csv_buffer)

            headers_written = False
            for point in result.get_points(measurement=measurement):
                if not headers_written:
                    headers = ["time"] + list(point.keys())
                    csv_writer.writerow(headers)
                    headers_written = True
                
                row = [point.get("time")]  # Including timestamp
                row += [point.get(field) for field in headers[1:]]
                csv_writer.writerow(row)
            
            # Move to the start of the buffer and upload
            csv_buffer.seek(0)
            upload_to_dropbox(csv_buffer.getvalue(), measurement)

client.close()
